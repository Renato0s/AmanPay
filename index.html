<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AmanPay Premium</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AmanPay">
    <meta name="theme-color" content="#10b981">
    
    <!-- Подключение внешнего манифеста -->
    <link rel="manifest" href="/manifest.json">

    <!-- Иконки -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="icon" type="image/png" href="/icon-192.png">

    <!-- Библиотеки -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        emerald: { 400: '#34d399', 500: '#10b981', 600: '#059669' },
                        slate: { 850: '#1e293b', 950: '#020617' }
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '3rem' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            padding-top: var(--sat);
            padding-bottom: var(--sab);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;
            background: #f8fafc;
        }

        .dark body { background: #020617; }
        
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 
            0%, 100% { transform: translateY(0px); } 
            50% { transform: translateY(-8px); } 
        }

        .animate-enter { animation: enter 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes enter { 
            from { opacity: 0; transform: translateY(15px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        .mesh-gradient {
            background: radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.12) 0px, transparent 50%),
                        radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.12) 0px, transparent 50%);
        }

        .premium-card {
            background: linear-gradient(135deg, #10b981 0%, #064e3b 100%);
            box-shadow: 0 15px 35px -5px rgba(16, 185, 129, 0.35);
            position: relative;
            overflow: hidden;
        }

        .glass-ui {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .dark .glass-ui {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input { font-size: 16px !important; }
    </style>
</head>
<body class="transition-colors duration-500">
    <div id="root"></div>

    <!-- Регистрация Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('PWA Service Worker зарегистрирован'))
                    .catch(err => {
                        console.warn('Регистрация SW не удалась в данной среде.');
                    });
            });
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Попытка использовать системную конфигурацию, если она доступна
        const defaultCfg = {
            apiKey: "AIzaSyBO9_w8ymwnX6Fje5czL0d3-bxRoa9OpT4",
            authDomain: "amanpay-790fd.firebaseapp.com",
            projectId: "amanpay-790fd",
            storageBucket: "amanpay-790fd.firebasestorage.app",
            messagingSenderId: "720784541108",
            appId: "1:720784541108:web:fa06ff39e7ea57f5ac1ee1"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultCfg;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'amanpay-v1';

        window.amanDB = {
            db, auth, appId,
            collections: {
                users: collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                txs: collection(db, 'artifacts', appId, 'public', 'data', 'transactions')
            },
            utils: { doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, addDoc, serverTimestamp, signInAnonymously, onAuthStateChanged, signInWithCustomToken, collection }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const formatMoney = (sum) => new Intl.NumberFormat('ru-RU', { 
            style: 'currency', currency: 'KGS', maximumFractionDigits: 0 
        }).format(sum || 0);

        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                if (type === 'receive') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(523.25, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(880.00, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                } else {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(220, ctx.currentTime + 0.15);
                    gain.gain.setValueAtTime(0, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                }

                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.6);
            } catch (e) { console.warn("Звук заблокирован"); }
        };

        const SvgIcon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                sun: <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" />,
                moon: <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />,
                back: <path d="M5 12h14M5 12l6 6M5 12l6-6" />,
                user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
                logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
                search: <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
                wallet: <path d="M17 8C19.2091 8 21 9.79086 21 12V16C21 18.2091 19.2091 20 17 20H7C4.79086 20 3 18.2091 3 16V8C3 5.79086 4.79086 4 7 4H17C17 4 17 8 17 8Z" />,
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10zM9 12l2 2 4-4" />,
                help: <path d="M12 16h.01M12 13a2 2 0 0 0 .9-3.42 2 2 0 0 0-2.82 0M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" />,
                install: <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2M7 11l5 5 5-5M12 4v12" />
            };
            return (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const App = () => {
            const [view, setView] = useState('welcome');
            const [user, setUser] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [isAuth, setIsAuth] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);

            useEffect(() => {
                const init = async () => {
                    if(!window.amanDB) return setTimeout(init, 100);
                    const { auth, utils } = window.amanDB;
                    
                    const initAuth = async () => {
                        const token = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) ? __initial_auth_token : null;
                        try {
                            if (token) {
                                await utils.signInWithCustomToken(auth, token);
                            } else {
                                await utils.signInAnonymously(auth);
                            }
                        } catch (e) {
                            // Ошибка mismatch перехватывается здесь и происходит анонимный вход
                            await utils.signInAnonymously(auth);
                        }
                    };
                    
                    await initAuth();
                    utils.onAuthStateChanged(auth, (u) => {
                        setIsAuth(!!u);
                    });
                };
                init();

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                });
            }, []);

            const handleInstall = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') setDeferredPrompt(null);
                }
            };

            const handleAuthResult = (u) => {
                setUser(u);
                setView(u.role === 'client' ? 'dash' : 'agent');
            };

            if(!isAuth) return <div className="min-h-screen bg-slate-50 dark:bg-slate-950 flex items-center justify-center"><div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div></div>;

            return (
                <div className={darkMode ? 'dark' : ''}>
                    <div className="bg-slate-50 dark:bg-slate-950 min-h-screen">
                        
                        {deferredPrompt && (
                            <button onClick={handleInstall} className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[60] bg-emerald-500 text-white px-8 py-4 rounded-full shadow-2xl flex items-center space-x-3 font-black animate-bounce ring-4 ring-emerald-500/20 active:scale-95 transition-all">
                                <SvgIcon name="install" className="w-6 h-6" />
                                <span>Установить AmanPay</span>
                            </button>
                        )}

                        <button onClick={() => setDarkMode(!darkMode)} className="fixed top-12 right-6 z-50 p-3 rounded-2xl glass-ui shadow-xl text-slate-800 dark:text-yellow-400 active:scale-90 transition-all">
                            <SvgIcon name={darkMode ? "sun" : "moon"} className="w-5 h-5" />
                        </button>

                        {view === 'welcome' && <WelcomeScreen onNavigate={setView} />}
                        {view === 'instructions' && <InstructionsScreen onBack={() => setView('welcome')} />}
                        {view === 'register' && <div className="animate-enter"><button onClick={() => setView('welcome')} className="fixed top-12 left-6 z-50 p-3 rounded-2xl glass-ui active:scale-90"><SvgIcon name="back" className="w-5 h-5 dark:text-white"/></button><Register onComplete={handleAuthResult} /></div>}
                        {view === 'login' && <div className="animate-enter"><button onClick={() => setView('welcome')} className="fixed top-12 left-6 z-50 p-3 rounded-2xl glass-ui active:scale-90"><SvgIcon name="back" className="w-5 h-5 dark:text-white"/></button><Login onComplete={handleAuthResult} /></div>}
                        {view === 'dash' && user && <Dashboard user={user} onLogout={() => setView('welcome')} />}
                        {view === 'agent' && user && <AgentPanel agent={user} onLogout={() => setView('welcome')} />}
                    </div>
                </div>
            );
        };

        const WelcomeScreen = ({ onNavigate }) => (
            <div className="min-h-screen flex flex-col items-center justify-between p-8 bg-slate-50 dark:bg-slate-950 mesh-gradient animate-enter">
                <div className="flex-1 flex flex-col items-center justify-center w-full">
                    <div className="relative mb-4">
                        <div className="w-24 h-24 animate-float bg-emerald-500 rounded-[2rem] flex items-center justify-center shadow-2xl relative z-20">
                            <SvgIcon name="shield" className="w-12 h-12 text-white" />
                        </div>
                        <div className="w-24 h-24 absolute top-3 left-3 bg-emerald-100 dark:bg-emerald-900/30 rounded-[2rem] z-10 rotate-12"></div>
                    </div>
                    <h1 className="text-4xl font-extrabold text-slate-900 dark:text-white tracking-tighter">AmanPay</h1>
                    <p className="text-slate-500 dark:text-slate-400 mt-6 mb-12 text-lg font-semibold max-w-[240px] text-center leading-snug">Безопасность и простота <br/>в каждом переводе</p>
                    <div className="w-full max-w-xs space-y-4">
                        <button onClick={() => onNavigate('login')} className="w-full bg-emerald-500 text-white font-extrabold py-5 rounded-3xl shadow-xl text-lg active:scale-95 transition-all">Войти</button>
                        <button onClick={() => onNavigate('register')} className="w-full bg-white dark:bg-slate-900 text-slate-900 dark:text-white font-extrabold py-5 rounded-3xl text-lg active:scale-95 transition-all shadow-md border border-slate-100 dark:border-slate-800">Регистрация</button>
                        <button onClick={() => onNavigate('instructions')} className="w-full flex items-center justify-center space-x-2 text-emerald-600 dark:text-emerald-400 font-bold py-2 active:scale-95 transition-all">
                            <SvgIcon name="help" className="w-4 h-4" />
                            <span className="text-sm">Как это работает?</span>
                        </button>
                    </div>
                </div>
            </div>
        );

        const InstructionsScreen = ({ onBack }) => {
            const [role, setRole] = useState('client');
            const steps = {
                client: [
                    { title: "Регистрация", text: "Создайте аккаунт как «Клиент»." },
                    { title: "Ваш ID", text: "Найдите свой 4-значный ID в кабинете." },
                    { title: "Пополнение", text: "Назовите ID агенту для внесения наличных." }
                ],
                agent: [
                    { title: "Роль Агента", text: "Выберите «Агент» при регистрации." },
                    { title: "Поиск", text: "Введите 4-значный ID клиента." },
                    { title: "Транзакции", text: "Принимайте или выдавайте наличные." }
                ]
            };
            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 p-6 pt-20 animate-enter flex flex-col smooth-scroll">
                    <button onClick={onBack} className="fixed top-12 left-6 z-50 p-3 rounded-2xl glass-ui active:scale-90 shadow-md text-slate-800 dark:text-white"><SvgIcon name="back" className="w-5 h-5"/></button>
                    <h2 className="text-4xl font-black dark:text-white mb-6 tracking-tight">Инструкция</h2>
                    <div className="flex p-1.5 bg-slate-200/50 dark:bg-slate-900 rounded-2xl mb-8">
                        <button onClick={() => setRole('client')} className={`flex-1 py-3 rounded-xl font-bold transition-all text-sm ${role === 'client' ? 'bg-white dark:bg-slate-800 text-emerald-600 shadow-sm' : 'text-slate-500'}`}>Клиенту</button>
                        <button onClick={() => setRole('agent')} className={`flex-1 py-3 rounded-xl font-bold transition-all text-sm ${role === 'agent' ? 'bg-white dark:bg-slate-800 text-emerald-600 shadow-sm' : 'text-slate-500'}`}>Агенту</button>
                    </div>
                    <div className="space-y-4">
                        {steps[role].map((step, idx) => (
                            <div key={idx} className="glass-ui p-6 rounded-3xl border border-white/50 animate-enter" style={{animationDelay: `${idx * 80}ms`}}>
                                <div className="flex items-center space-x-3 mb-2">
                                    <div className="w-8 h-8 bg-emerald-500 rounded-xl flex items-center justify-center text-white font-black text-xs">{idx + 1}</div>
                                    <h4 className="text-lg font-extrabold dark:text-white tracking-tight">{step.title}</h4>
                                </div>
                                <p className="text-sm text-slate-500 dark:text-slate-400 font-medium">{step.text}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout }) => {
            const [balance, setBalance] = useState(user.balance);
            const [history, setHistory] = useState([]);
            const prevTxsCount = useRef(0);
            const isFirstLoad = useRef(true);

            useEffect(() => {
                const { utils, db, appId, collections } = window.amanDB;
                if (!user) return;

                const userRef = utils.doc(db, 'artifacts', appId, 'public', 'data', 'users', user.fireId);
                const unsub = utils.onSnapshot(userRef, (s) => s.exists() && setBalance(s.data().balance), (err) => console.error(err));

                const q = utils.query(collections.txs);
                const unsubH = utils.onSnapshot(q, (s) => {
                    const data = s.docs.map(d => ({...d.data(), id: d.id})).filter(t => t.userId === user.id).sort((a,b) => b.timestamp - a.timestamp);
                    if (!isFirstLoad.current && data.length > prevTxsCount.current) {
                        playSound(data[0].type === 'deposit' ? 'receive' : 'send');
                    }
                    setHistory(data);
                    prevTxsCount.current = data.length;
                    isFirstLoad.current = false;
                }, (err) => console.error(err));

                return () => { unsub(); unsubH(); };
            }, [user]);

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 animate-enter flex flex-col smooth-scroll pb-20">
                    <div className="px-5 pt-16 pb-12">
                        <div className="premium-card p-6 rounded-[2.5rem] text-white flex flex-col justify-between h-56 relative">
                            <div className="flex justify-between items-start relative z-10">
                                <div><p className="opacity-70 text-[9px] font-black uppercase tracking-widest mb-0.5">Баланс</p><h1 className="text-4xl font-black tracking-tight">{formatMoney(balance)}</h1></div>
                                <button onClick={onLogout} className="bg-white/20 backdrop-blur-md p-3 rounded-2xl active:scale-90"><SvgIcon name="logout" className="w-5 h-5"/></button>
                            </div>
                            <div className="flex justify-between items-end relative z-10">
                                <div><p className="text-[10px] font-bold opacity-60 mb-0.5 uppercase">Держатель</p><p className="text-lg font-black">{user.name}</p></div>
                                <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center border border-white/10"><SvgIcon name="wallet" className="w-5 h-5"/></div>
                            </div>
                        </div>
                    </div>
                    <div className="flex-1 px-5 space-y-8">
                        <div className="glass-ui p-8 rounded-[2rem] text-center shadow-lg flex flex-col items-center">
                            <p className="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase mb-4 tracking-widest">Персональный ID</p>
                            <div className="bg-emerald-500/5 dark:bg-emerald-500/10 px-6 py-4 rounded-2xl border-2 border-emerald-500/10 mb-4"><span className="text-5xl font-black text-emerald-600 dark:text-emerald-400 tracking-[0.1em]">{user.id}</span></div>
                            <p className="text-slate-400 dark:text-slate-500 text-xs font-semibold px-2 leading-relaxed">Назовите эти цифры агенту <br/>для внесения или снятия</p>
                        </div>
                        <div className="pb-8 px-1">
                           <h3 className="text-2xl font-black dark:text-white tracking-tight mb-6">Активность</h3>
                           <div className="space-y-3">
                               {history.length > 0 ? history.map((tx, idx) => (
                                   <div key={tx.id || idx} className="glass-ui p-4 rounded-2xl flex justify-between items-center shadow-sm animate-enter">
                                       <div className="flex items-center">
                                           <div className={`w-11 h-11 rounded-xl flex items-center justify-center mr-4 ${tx.type==='deposit'?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-600'}`}><SvgIcon name={tx.type==='deposit' ? 'wallet' : 'logout'} className={`w-5 h-5 ${tx.type==='withdraw' ? 'rotate-90' : ''}`} /></div>
                                           <div><p className="font-black dark:text-white text-base leading-tight">{tx.type==='deposit'?'Приход':'Выдача'}</p><p className="text-[9px] text-slate-400 font-bold uppercase mt-0.5">{tx.agentName}</p></div>
                                       </div>
                                       <p className={`font-black text-lg tracking-tighter ${tx.type==='deposit'?'text-emerald-600':'dark:text-white'}`}>{tx.type==='deposit'?'+':'-'}{formatMoney(tx.amount)}</p>
                                   </div>
                               )) : <p className="text-slate-400 text-center py-10 font-bold">История пуста</p>}
                           </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AgentPanel = ({ agent, onLogout }) => {
            const [searchId, setSearchId] = useState('');
            const [foundUser, setFoundUser] = useState(null);
            const [amount, setAmount] = useState('');
            const [msg, setMsg] = useState(null);
            const [isSearching, setIsSearching] = useState(false);

            const handleSearch = async () => {
                if(searchId.length < 4) return;
                setIsSearching(true); setMsg(null);
                const { collections, utils } = window.amanDB;
                const snap = await utils.getDocs(collections.users);
                const found = snap.docs.find(d => d.data().id === searchId && d.data().role === 'client');
                if(found) setFoundUser({...found.data(), fireId: found.id});
                else setMsg({type:'error', text:'Клиент не найден'});
                setIsSearching(false);
            };

            const handleOp = async (type) => {
                const val = parseInt(amount); if(!val) return;
                const { utils, db, appId } = window.amanDB;
                if(type === 'withdraw' && foundUser.balance < val) return setMsg({type:'error', text:'Недостаточно средств'});
                try {
                    const newB = type === 'deposit' ? foundUser.balance + val : foundUser.balance - val;
                    const userRef = utils.doc(db, 'artifacts', appId, 'public', 'data', 'users', foundUser.fireId);
                    await utils.updateDoc(userRef, { balance: newB });
                    
                    const txsCol = utils.collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                    await utils.addDoc(txsCol, { type, amount: val, userId: foundUser.id, agentName: agent.name, timestamp: Date.now() });
                    
                    playSound(type === 'deposit' ? 'receive' : 'send');
                    setFoundUser({...foundUser, balance: newB}); 
                    setMsg({type:'success', text:'Успешно'}); 
                    setAmount('');
                } catch(e) { setMsg({type:'error', text:'Ошибка'}); }
            };

            return (
                <div className="min-h-screen bg-slate-900 text-white animate-enter flex flex-col pb-20">
                    <div className="p-8 pt-16 flex justify-between items-center bg-slate-950/40 rounded-b-[3rem]">
                        <div><p className="text-emerald-400 text-[9px] font-black uppercase mb-0.5 tracking-widest">Агент</p><h2 className="text-2xl font-black leading-tight">{agent.name}</h2></div>
                        <button onClick={onLogout} className="bg-slate-800 p-3 rounded-2xl active:scale-90 border border-slate-700 shadow-md"><SvgIcon name="logout" className="w-5 h-5"/></button>
                    </div>
                    <div className="px-6 flex-1 flex flex-col items-center pt-8">
                        <div className="bg-slate-800/40 p-8 rounded-[2.5rem] w-full max-w-[320px] mb-8 border border-slate-700 shadow-xl text-center backdrop-blur-md">
                            <p className="text-[9px] font-black text-slate-500 uppercase mb-6 tracking-widest">ID Клиента</p>
                            <div className="flex items-center justify-center space-x-3">
                                <input type="number" inputMode="numeric" placeholder="0000" className="w-32 bg-slate-950 border-2 border-slate-700 rounded-2xl py-4 text-center text-4xl font-black outline-none focus:border-emerald-500 transition-all shadow-inner" value={searchId} onChange={e => {
                                    const v = e.target.value.slice(0,4);
                                    setSearchId(v);
                                    if(v.length === 4) { setFoundUser(null); setTimeout(handleSearch, 100); }
                                }} />
                                <button onClick={handleSearch} className="bg-emerald-500 p-4 rounded-xl shadow-lg active:scale-90 flex items-center justify-center">{isSearching ? <div className="w-6 h-6 border-2 border-white/20 border-t-white rounded-full animate-spin"></div> : <SvgIcon name="search" className="w-6 h-6"/>}</button>
                            </div>
                        </div>
                        {msg && <div className={`p-4 rounded-2xl mb-6 w-full max-w-[320px] text-center font-black text-sm animate-enter ${msg.type==='success'?'bg-emerald-500/10 text-emerald-400':'bg-rose-500/10 text-rose-400'}`}>{msg.text}</div>}
                        {foundUser && (
                            <div className="bg-white text-slate-900 rounded-[2.5rem] p-8 w-full max-w-[360px] animate-enter shadow-xl relative">
                                <h3 className="text-2xl font-black mb-1 tracking-tight leading-tight">{foundUser.name}</h3>
                                <p className="text-slate-400 font-extrabold text-[9px] uppercase mb-6 tracking-widest">Баланс: {formatMoney(foundUser.balance)}</p>
                                <div className="space-y-6">
                                    <input type="number" inputMode="numeric" placeholder="Сумма" className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-6 px-4 text-5xl font-black text-center outline-none focus:border-emerald-500 shadow-inner" value={amount} onChange={e => setAmount(e.target.value)} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => handleOp('deposit')} className="bg-emerald-500 text-white p-6 rounded-2xl font-black flex flex-col items-center shadow-lg active:scale-95 text-sm transition-all"><SvgIcon name="wallet" className="mb-2 w-7 h-7"/>Принять</button>
                                        <button onClick={() => handleOp('withdraw')} className="bg-slate-900 text-white p-6 rounded-2xl font-black flex flex-col items-center shadow-lg active:scale-95 text-sm transition-all"><SvgIcon name="logout" className="rotate-90 mb-2 w-7 h-7"/>Выдать</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Register = ({ onComplete }) => {
            const [f, setF] = useState({ name: '', email: '', password: '', role: 'client' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const h = async () => {
                if(!f.name || !f.email || !f.password) return;
                setLoading(true); setError('');
                const { setDoc, doc, getDocs, db, appId, collection } = window.amanDB;
                try {
                    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                    if (snap.docs.some(d => d.data().email === f.email)) {
                        setError('Email уже занят'); setLoading(false); return;
                    }
                    const id = Math.floor(1000 + Math.random() * 9000).toString();
                    const newUserRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                    const u = { ...f, id, balance: 0, fireId: newUserRef.id };
                    await setDoc(newUserRef, u);
                    onComplete(u);
                } catch(e) { setError('Ошибка'); setLoading(false); }
            };
            return (
                <div className="min-h-screen p-8 pt-36 max-w-sm mx-auto pb-20">
                    <h2 className="text-4xl font-black dark:text-white mb-8 tracking-tight">Регистрация</h2>
                    <div className="space-y-4">
                        <input placeholder="Имя" className="w-full p-5 rounded-2xl bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, name: e.target.value})} />
                        <input placeholder="Email" type="email" className="w-full p-5 rounded-2xl bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, email: e.target.value})} />
                        <input placeholder="Пароль" type="password" className="w-full p-5 rounded-2xl bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, password: e.target.value})} />
                        {error && <p className="text-rose-500 font-bold text-sm px-1">{error}</p>}
                        <div className="grid grid-cols-2 gap-3 pt-2">
                            <button onClick={() => setF({...f, role:'client'})} className={`py-4 rounded-2xl font-black text-sm ${f.role==='client'?'bg-emerald-500 text-white shadow-lg':'bg-white dark:bg-slate-900 dark:text-white border-2 border-slate-100 dark:border-slate-800'}`}>Клиент</button>
                            <button onClick={() => setF({...f, role:'agent'})} className={`py-4 rounded-2xl font-black text-sm ${f.role==='agent'?'bg-emerald-500 text-white shadow-lg':'bg-white dark:bg-slate-900 dark:text-white border-2 border-slate-100 dark:border-slate-800'}`}>Агент</button>
                        </div>
                    </div>
                    <button onClick={h} disabled={loading} className="w-full mt-8 bg-emerald-500 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95">{loading ? 'Создание...' : 'Завершить'}</button>
                </div>
            );
        };

        const Login = ({ onComplete }) => {
            const [f, setF] = useState({ email: '', password: '' });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const h = async () => {
                if(!f.email || !f.password) return;
                setLoading(true); setError('');
                const { getDocs, collection, db, appId } = window.amanDB;
                const usersCol = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const snap = await getDocs(usersCol);
                const found = snap.docs.find(d => d.data().email === f.email && d.data().password === f.password);
                if(found) {
                    onComplete({...found.data(), fireId: found.id});
                } else {
                    setError('Неверные данные'); setLoading(false);
                }
            };
            return (
                <div className="min-h-screen p-8 pt-36 max-w-sm mx-auto pb-20">
                    <h2 className="text-4xl font-black dark:text-white mb-8 tracking-tight">Вход</h2>
                    <div className="space-y-4">
                        <input placeholder="Email" type="email" className="w-full p-5 rounded-2xl bg-white dark:bg-slate-900 dark:text-white outline-none border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500" onChange={e => setF({...f, email: e.target.value})} />
                        <input placeholder="Пароль" type="password" className="w-full p-5 rounded-2xl bg-white dark:bg-slate-900 dark:text-white outline-none border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500" onChange={e => setF({...f, password: e.target.value})} />
                        {error && <p className="text-rose-500 font-bold text-sm px-1">{error}</p>}
                    </div>
                    <button onClick={h} disabled={loading} className="w-full mt-8 bg-emerald-500 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95">{loading ? 'Вход...' : 'Войти'}</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
