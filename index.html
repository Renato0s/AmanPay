<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AmanPay</title>
    
    <!-- Полная мобильная интеграция -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AmanPay">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#10b981">
    
    <!-- Гарантированные иконки (Зеленый щит) -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/240/shield-with-check-mark.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/240/shield-with-check-mark.png">

    <!-- Подключение библиотек -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        emerald: { 500: '#10b981', 600: '#059669' },
                        slate: { 950: '#020617' }
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '3rem' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            padding-top: var(--sat);
            padding-bottom: var(--sab);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;
        }
        
        .animate-pop { animation: pop 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.28); }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        input { font-size: 16px !important; } /* Предотвращает зум на iOS */
        
        .safe-area-spacing {
            padding-top: calc(1rem + var(--sat));
            padding-bottom: calc(1rem + var(--sab));
        }

        .qr-card {
            background: white;
            padding: 2rem;
            border-radius: 3rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            border: 4px solid #10b981;
        }

        .dark .qr-card {
            background: #0f172a;
            border-color: #10b981;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 transition-colors duration-300">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBO9_w8ymwnX6Fje5czL0d3-bxRoa9OpT4",
            authDomain: "amanpay-790fd.firebaseapp.com",
            projectId: "amanpay-790fd",
            storageBucket: "amanpay-790fd.firebasestorage.app",
            messagingSenderId: "720784541108",
            appId: "1:720784541108:web:fa06ff39e7ea57f5ac1ee1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'amanpay-v1';

        window.amanDB = {
            db, auth, appId,
            collections: {
                users: collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                txs: collection(db, 'artifacts', appId, 'public', 'data', 'transactions')
            },
            utils: { doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, addDoc, serverTimestamp, signInAnonymously, onAuthStateChanged }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const formatMoney = (sum) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'KGS', maximumFractionDigits: 0 }).format(sum || 0);

        const SvgIcon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                sun: <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" />,
                moon: <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />,
                back: <path d="M5 12h14M5 12l6 6M5 12l6-6" />,
                user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
                logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10zM9 12l2 2 4-4" />
            };
            return <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        const ThemeToggle = ({ darkMode, setDarkMode }) => (
            <button onClick={() => setDarkMode(!darkMode)} className="fixed top-14 right-6 z-50 p-4 rounded-3xl bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg shadow-xl border border-slate-100 dark:border-slate-800 text-slate-800 dark:text-yellow-400 active:scale-90 transition-all">
                <SvgIcon name={darkMode ? "sun" : "moon"} />
            </button>
        );

        const AppLogo = ({ size = "normal" }) => (
            <div className="flex flex-col items-center animate-fade-in">
                <div className="relative mb-6">
                    <div className={`${size === 'small' ? 'w-20 h-20' : 'w-32 h-32'} bg-emerald-500 rounded-[2.5rem] flex items-center justify-center shadow-2xl shadow-emerald-500/40 relative z-20`}>
                        <SvgIcon name="shield" className={size === 'small' ? 'w-10 h-10 text-white' : 'w-16 h-16 text-white'} />
                    </div>
                    <div className={`${size === 'small' ? 'w-20 h-20' : 'w-32 h-32'} absolute top-3 left-3 bg-emerald-100 dark:bg-emerald-900/30 rounded-[2.5rem] z-10 rotate-6`}></div>
                </div>
                {size !== 'small' && <h1 className="text-6xl font-black text-slate-900 dark:text-white tracking-tighter">AmanPay</h1>}
            </div>
        );

        const WelcomeScreen = ({ onNavigate }) => (
            <div className="min-h-screen flex flex-col items-center justify-between p-10 bg-white dark:bg-slate-950 text-center animate-fade-in">
                <div className="flex-1 flex flex-col items-center justify-center w-full">
                    <AppLogo />
                    <p className="text-slate-500 mt-8 mb-14 text-lg font-medium max-w-[260px]">Финансовая свобода <br/>в вашем смартфоне</p>
                    <div className="w-full max-w-xs space-y-4">
                        <button onClick={() => onNavigate('login')} className="w-full bg-emerald-500 text-white font-black py-5 rounded-[2rem] shadow-2xl shadow-emerald-500/30 text-xl active:scale-95 transition-all">Войти</button>
                        <button onClick={() => onNavigate('register')} className="w-full bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-white font-black py-5 rounded-[2rem] text-xl active:scale-95 transition-all border-2 border-transparent">Регистрация</button>
                    </div>
                </div>
                <p className="text-slate-400 dark:text-slate-600 text-[10px] font-black uppercase tracking-widest pb-6">Создатель Гафуров Ренат</p>
            </div>
        );

        const Dashboard = ({ user, onLogout }) => {
            const [balance, setBalance] = useState(user.balance);
            const [history, setHistory] = useState([]);

            useEffect(() => {
                const { collections, utils } = window.amanDB;
                const unsub = utils.onSnapshot(utils.doc(collections.users, user.fireId), (s) => s.exists() && setBalance(s.data().balance));
                const unsubH = utils.onSnapshot(collections.txs, (s) => {
                    const data = s.docs.map(d => d.data()).filter(t => t.userId === user.id).sort((a,b) => b.timestamp - a.timestamp);
                    setHistory(data);
                });
                return () => { unsub(); unsubH(); };
            }, [user.id, user.fireId]);

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 animate-fade-in flex flex-col">
                    <div className="bg-emerald-600 pt-20 pb-16 px-8 rounded-b-[4rem] shadow-2xl text-white relative overflow-hidden">
                        <div className="absolute -top-20 -right-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
                        <div className="flex justify-between items-start relative z-10 mb-8">
                            <div><p className="opacity-70 text-xs font-black uppercase mb-1">Баланс</p><h1 className="text-6xl font-black">{formatMoney(balance)}</h1></div>
                            <button onClick={onLogout} className="bg-white/20 p-4 rounded-3xl active:scale-90"><SvgIcon name="logout" /></button>
                        </div>
                        <div className="bg-black/20 p-5 rounded-3xl flex items-center relative z-10 border border-white/10"><div className="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center mr-4"><SvgIcon name="user" className="w-6 h-6"/></div><p className="font-bold text-xl">{user.name}</p></div>
                    </div>
                    
                    <div className="flex-1 -mt-10 px-6 flex flex-col items-center">
                        <div className="qr-card text-center mb-10 w-full max-w-sm">
                            <p className="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">ID Клиента</p>
                            <div className="bg-slate-50 p-6 rounded-3xl inline-block mb-4 border-2 border-emerald-500/20"><span className="text-5xl font-black text-slate-900 tracking-widest">{user.id}</span></div>
                            <p className="text-slate-400 dark:text-slate-500 text-xs font-bold px-4">Покажите этот ID агенту для совершения операции</p>
                        </div>
                        
                        <div className="w-full max-w-md pb-10">
                            <h3 className="text-2xl font-black mb-6 dark:text-white px-2">Активность</h3>
                            <div className="space-y-4">
                                {history.map((tx, idx) => (
                                    <div key={idx} className="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] flex justify-between items-center shadow-lg border border-slate-50 dark:border-slate-800 animate-fade-in" style={{animationDelay: `${idx*50}ms`}}>
                                        <div className="flex items-center"><div className={`w-12 h-12 rounded-2xl flex items-center justify-center mr-4 ${tx.type==='deposit'?'bg-emerald-50 text-emerald-600':'bg-rose-50 text-rose-600'}`}><SvgIcon name="shield" className="w-6 h-6" /></div><div><p className="font-black dark:text-white text-lg">{tx.type==='deposit'?'Приход':'Расход'}</p><p className="text-[10px] text-slate-400 font-bold uppercase">{tx.agentName}</p></div></div>
                                        <p className={`font-black text-xl ${tx.type==='deposit'?'text-emerald-600':'dark:text-white'}`}>{tx.type==='deposit'?'+':'-'}{formatMoney(tx.amount)}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AgentPanel = ({ agent, onLogout }) => {
            const [searchId, setSearchId] = useState('');
            const [user, setUser] = useState(null);
            const [amount, setAmount] = useState('');
            const [msg, setMsg] = useState(null);

            const handleSearch = async () => {
                if(searchId.length < 4) return;
                const { collections, utils } = window.amanDB;
                const snap = await utils.getDocs(collections.users);
                const found = snap.docs.find(d => d.data().id === searchId && d.data().role === 'client');
                if(found) setUser({...found.data(), fireId: found.id});
                else setMsg({type:'error', text:'ID не найден'});
            };

            const handleOp = async (type) => {
                const val = parseInt(amount); if(!val) return;
                const { utils, collections } = window.amanDB;
                if(type === 'withdraw' && user.balance < val) return setMsg({type:'error', text:'Мало средств'});
                const newB = type === 'deposit' ? user.balance + val : user.balance - val;
                await utils.updateDoc(utils.doc(collections.users, user.fireId), { balance: newB });
                await utils.addDoc(collections.txs, { type, amount: val, userId: user.id, agentName: agent.name, timestamp: Date.now() });
                setUser({...user, balance: newB}); setMsg({type:'success', text:'Готово!'}); setAmount('');
            };

            return (
                <div className="min-h-screen bg-slate-900 text-white animate-fade-in flex flex-col">
                    <div className="p-10 pt-20 flex justify-between items-center">
                        <div><p className="text-emerald-400 text-[10px] font-black uppercase mb-1">Агент</p><h2 className="text-4xl font-black">{agent.name}</h2></div>
                        <button onClick={onLogout} className="bg-slate-800 p-4 rounded-3xl"><SvgIcon name="logout"/></button>
                    </div>
                    
                    <div className="px-8 flex-1 flex flex-col items-center">
                        {/* КОМПАКТНЫЙ ПОИСК */}
                        <div className="bg-slate-800 p-8 rounded-[3rem] w-full max-w-[320px] mb-8 border border-slate-700 shadow-2xl text-center">
                            <p className="text-[10px] font-black text-slate-500 uppercase mb-6 tracking-widest">Поиск клиента</p>
                            <div className="flex items-center justify-center space-x-3">
                                <input type="number" inputmode="numeric" placeholder="0000" className="w-32 bg-slate-950 border-2 border-slate-700 rounded-2xl py-4 text-center text-4xl font-black outline-none focus:border-emerald-500 transition-all" value={searchId} onChange={e => {setSearchId(e.target.value.slice(0,4)); if(e.target.value.length === 4) setTimeout(handleSearch, 100);}} />
                                <button onClick={handleSearch} className="bg-emerald-500 p-5 rounded-2xl shadow-xl active:scale-90"><SvgIcon name="user" className="w-8 h-8"/></button>
                            </div>
                        </div>

                        {msg && <div className={`p-5 rounded-3xl mb-8 w-full max-w-[320px] text-center font-bold animate-pop ${msg.type==='success'?'bg-emerald-500/20 text-emerald-400':'bg-rose-500/20 text-rose-400'}`}>{msg.text}</div>}

                        {user && (
                            <div className="bg-white text-slate-900 rounded-[4rem] p-10 w-full max-w-[360px] animate-pop shadow-2xl">
                                <h3 className="text-3xl font-black mb-1">{user.name}</h3>
                                <p className="text-slate-400 font-bold text-xs uppercase mb-8">Баланс: {formatMoney(user.balance)}</p>
                                <input type="number" inputmode="numeric" placeholder="Сумма" className="w-full bg-slate-50 border-2 border-slate-100 rounded-3xl py-8 px-6 text-6xl font-black text-center mb-8 outline-none focus:border-emerald-500" value={amount} onChange={e => setAmount(e.target.value)} />
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => handleOp('deposit')} className="bg-emerald-500 text-white p-8 rounded-[2rem] font-black flex flex-col items-center active:scale-95"><SvgIcon name="shield" className="mb-2"/>Принять</button>
                                    <button onClick={() => handleOp('withdraw')} className="bg-slate-900 text-white p-8 rounded-[2rem] font-black flex flex-col items-center active:scale-95"><SvgIcon name="logout" className="rotate-90 mb-2"/>Выдать</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('welcome');
            const [user, setUser] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [isAuth, setIsAuth] = useState(false);

            useEffect(() => {
                const init = async () => {
                    if(!window.amanDB) return setTimeout(init, 100);
                    const { auth, utils } = window.amanDB;
                    await utils.signInAnonymously(auth);
                    utils.onAuthStateChanged(auth, (u) => setIsAuth(!!u));
                };
                init();
            }, []);

            if(!isAuth) return <div className="min-h-screen bg-white dark:bg-slate-950 flex items-center justify-center"><div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div></div>;

            return (
                <div className={darkMode ? 'dark' : ''}>
                    <ThemeToggle darkMode={darkMode} setDarkMode={setDarkMode} />
                    {view === 'welcome' && <WelcomeScreen onNavigate={setView} />}
                    {view === 'register' && <div className="animate-fade-in"><button onClick={() => setView('welcome')} className="fixed top-14 left-6 z-50 p-4 rounded-3xl bg-slate-100 dark:bg-slate-900 active:scale-90"><SvgIcon name="back"/></button><Register onComplete={(u) => {setUser(u); setView(u.role==='client'?'dash':'agent');}} /></div>}
                    {view === 'login' && <div className="animate-fade-in"><button onClick={() => setView('welcome')} className="fixed top-14 left-6 z-50 p-4 rounded-3xl bg-slate-100 dark:bg-slate-900 active:scale-90"><SvgIcon name="back"/></button><Login onComplete={(u) => {setUser(u); setView(u.role==='client'?'dash':'agent');}} /></div>}
                    {view === 'dash' && <Dashboard user={user} onLogout={() => setView('welcome')} />}
                    {view === 'agent' && <AgentPanel agent={user} onLogout={() => setView('welcome')} />}
                </div>
            );
        };

        const Register = ({ onComplete }) => {
            const [f, setF] = useState({ name: '', email: '', password: '', role: 'client' });
            const h = async () => {
                const { setDoc, doc } = window.amanDB.utils;
                const id = Math.floor(1000 + Math.random() * 9000).toString();
                const ref = doc(window.amanDB.collections.users);
                const u = { ...f, id, balance: 0, fireId: ref.id };
                await setDoc(ref, u);
                onComplete(u);
            };
            return (
                <div className="min-h-screen p-8 pt-40 bg-white dark:bg-slate-950">
                    <h2 className="text-5xl font-black dark:text-white mb-10">Регистрация</h2>
                    <div className="space-y-4">
                        <input placeholder="ФИО" className="w-full p-6 rounded-3xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, name: e.target.value})} />
                        <input placeholder="Email" className="w-full p-6 rounded-3xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, email: e.target.value})} />
                        <input placeholder="Пароль" type="password" className="w-full p-6 rounded-3xl bg-slate-50 dark:bg-slate-900 border-2 border-transparent focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, password: e.target.value})} />
                        <div className="grid grid-cols-2 gap-4 pt-4">
                            <button onClick={() => setF({...f, role:'client'})} className={`p-6 rounded-[2rem] font-black ${f.role==='client'?'bg-emerald-500 text-white':'bg-slate-100 dark:bg-slate-900 dark:text-white'}`}>Клиент</button>
                            <button onClick={() => setF({...f, role:'agent'})} className={`p-6 rounded-[2rem] font-black ${f.role==='agent'?'bg-emerald-500 text-white':'bg-slate-100 dark:bg-slate-900 dark:text-white'}`}>Агент</button>
                        </div>
                    </div>
                    <button onClick={h} className="w-full mt-10 bg-emerald-500 text-white py-6 rounded-[2rem] font-black text-xl shadow-2xl">Создать</button>
                </div>
            );
        };

        const Login = ({ onComplete }) => {
            const [f, setF] = useState({ email: '', password: '' });
            const h = async () => {
                const snap = await window.amanDB.utils.getDocs(window.amanDB.collections.users);
                const found = snap.docs.find(d => d.data().email === f.email && d.data().password === f.password);
                if(found) onComplete({...found.data(), fireId: found.id});
            };
            return (
                <div className="min-h-screen p-8 pt-40 bg-white dark:bg-slate-950">
                    <h2 className="text-5xl font-black dark:text-white mb-10">Вход</h2>
                    <div className="space-y-4">
                        <input placeholder="Email" className="w-full p-6 rounded-3xl bg-slate-50 dark:bg-slate-900 dark:text-white outline-none" onChange={e => setF({...f, email: e.target.value})} />
                        <input placeholder="Пароль" type="password" className="w-full p-6 rounded-3xl bg-slate-50 dark:bg-slate-900 dark:text-white outline-none" onChange={e => setF({...f, password: e.target.value})} />
                    </div>
                    <button onClick={h} className="w-full mt-10 bg-emerald-500 text-white py-6 rounded-[2rem] font-black text-xl shadow-2xl">Войти</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
