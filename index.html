<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AmanPay Premium</title>
    
    <!-- PWA Настройки -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AmanPay">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#10b981">
    
    <!-- Иконки -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/240/shield-with-check-mark.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/240/shield-with-check-mark.png">

    <!-- Библиотеки -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        emerald: { 400: '#34d399', 500: '#10b981', 600: '#059669' },
                        slate: { 850: '#1e293b', 950: '#020617' }
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '3rem' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            padding-top: var(--sat);
            padding-bottom: var(--sab);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;
            background: #f8fafc;
        }

        .dark body { background: #020617; }
        
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 
            0%, 100% { transform: translateY(0px); } 
            50% { transform: translateY(-10px); } 
        }

        .animate-enter { animation: enter 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes enter { 
            from { opacity: 0; transform: translateY(20px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        .mesh-gradient {
            background: radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.15) 0px, transparent 50%),
                        radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.15) 0px, transparent 50%);
        }

        .premium-card {
            background: linear-gradient(135deg, #10b981 0%, #064e3b 100%);
            box-shadow: 0 20px 40px -10px rgba(16, 185, 129, 0.4);
            position: relative;
            overflow: hidden;
        }

        .premium-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .glass-ui {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .dark .glass-ui {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="transition-colors duration-500">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBO9_w8ymwnX6Fje5czL0d3-bxRoa9OpT4",
            authDomain: "amanpay-790fd.firebaseapp.com",
            projectId: "amanpay-790fd",
            storageBucket: "amanpay-790fd.firebasestorage.app",
            messagingSenderId: "720784541108",
            appId: "1:720784541108:web:fa06ff39e7ea57f5ac1ee1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'amanpay-v1';

        window.amanDB = {
            db, auth, appId,
            collections: {
                users: collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                txs: collection(db, 'artifacts', appId, 'public', 'data', 'transactions')
            },
            utils: { doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, addDoc, serverTimestamp, signInAnonymously, onAuthStateChanged }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const formatMoney = (sum) => new Intl.NumberFormat('ru-RU', { 
            style: 'currency', currency: 'KGS', maximumFractionDigits: 0 
        }).format(sum || 0);

        // --- Система синтеза звуков ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                if (type === 'receive') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(523.25, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(880.00, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                } else {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(220, ctx.currentTime + 0.15);
                    gain.gain.setValueAtTime(0, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                }

                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.6);
            } catch (e) { console.warn("Sound blocked"); }
        };

        const SvgIcon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                sun: <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" />,
                moon: <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />,
                back: <path d="M5 12h14M5 12l6 6M5 12l6-6" />,
                user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
                logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
                search: <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
                wallet: <path d="M17 8C19.2091 8 21 9.79086 21 12V16C21 18.2091 19.2091 20 17 20H7C4.79086 20 3 18.2091 3 16V8C3 5.79086 4.79086 4 7 4H17C17 4 17 8 17 8Z" />,
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10zM9 12l2 2 4-4" />,
                help: <path d="M12 16h.01M12 13a2 2 0 0 0 .9-3.42 2 2 0 0 0-2.82 0M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" />
            };
            return (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const ThemeToggle = ({ darkMode, setDarkMode }) => (
            <button onClick={() => setDarkMode(!darkMode)} className="fixed top-14 right-6 z-50 p-4 rounded-3xl glass-ui shadow-2xl text-slate-800 dark:text-yellow-400 active:scale-90 transition-all duration-300">
                <SvgIcon name={darkMode ? "sun" : "moon"} />
            </button>
        );

        const AppLogo = ({ size = "normal" }) => (
            <div className="flex flex-col items-center animate-enter">
                <div className="relative mb-6">
                    <div className={`${size === 'small' ? 'w-20 h-20' : 'w-32 h-32 animate-float'} bg-emerald-500 rounded-[2.8rem] flex items-center justify-center shadow-2xl shadow-emerald-500/40 relative z-20`}>
                        <SvgIcon name="shield" className={size === 'small' ? 'w-10 h-10 text-white' : 'w-16 h-16 text-white'} />
                    </div>
                    <div className={`${size === 'small' ? 'w-20 h-20' : 'w-32 h-32'} absolute top-4 left-4 bg-emerald-100 dark:bg-emerald-900/30 rounded-[2.8rem] z-10 rotate-12`}></div>
                </div>
                {size !== 'small' && <h1 className="text-6xl font-extrabold text-slate-900 dark:text-white tracking-tighter">AmanPay</h1>}
            </div>
        );

        const WelcomeScreen = ({ onNavigate }) => (
            <div className="min-h-screen flex flex-col items-center justify-between p-10 bg-slate-50 dark:bg-slate-950 mesh-gradient animate-enter">
                <div className="flex-1 flex flex-col items-center justify-center w-full">
                    <AppLogo />
                    <p className="text-slate-500 dark:text-slate-400 mt-10 mb-16 text-xl font-semibold max-w-[280px] text-center leading-relaxed">Безопасность и простота <br/>в каждом переводе</p>
                    <div className="w-full max-w-xs space-y-5">
                        <button onClick={() => onNavigate('login')} className="w-full bg-emerald-500 text-white font-extrabold py-6 rounded-[2.2rem] shadow-2xl shadow-emerald-500/40 text-xl active:scale-95 transition-all">Войти</button>
                        <button onClick={() => onNavigate('register')} className="w-full bg-white dark:bg-slate-900 text-slate-900 dark:text-white font-extrabold py-6 rounded-[2.2rem] text-xl active:scale-95 transition-all shadow-lg border border-slate-100 dark:border-slate-800">Регистрация</button>
                        <button onClick={() => onNavigate('instructions')} className="w-full flex items-center justify-center space-x-3 text-emerald-600 dark:text-emerald-400 font-bold py-4 active:scale-95 transition-all">
                            <SvgIcon name="help" className="w-5 h-5" />
                            <span>Как это работает?</span>
                        </button>
                    </div>
                </div>
                <div className="pb-4">
                    <p className="text-slate-400 dark:text-slate-600 text-xs font-black uppercase tracking-[0.3em] opacity-60">Gafurov Renat Production</p>
                </div>
            </div>
        );

        const InstructionsScreen = ({ onBack }) => {
            const [role, setRole] = useState('client');
            const steps = {
                client: [
                    { title: "Регистрация", text: "Создайте аккаунт, выбрав роль «Клиент». Это займет меньше минуты." },
                    { title: "Ваш ID", text: "В личном кабинете вы увидите уникальный 4-значный номер. Это ваш адрес для переводов." },
                    { title: "Пополнение", text: "Найдите ближайшего агента AmanPay и назовите ему свой ID для внесения наличных." },
                    { title: "История", text: "Все ваши операции мгновенно отображаются в ленте активности под балансом." }
                ],
                agent: [
                    { title: "Роль Агента", text: "При регистрации выберите «Агент». Вам откроется терминал обслуживания." },
                    { title: "Поиск Клиента", text: "Введите 4-значный ID клиента. Система сразу найдет его профиль и текущий баланс." },
                    { title: "Транзакции", text: "Введите сумму и выберите «Принять» (пополнение) или «Выдать» (снятие наличных)." },
                    { title: "Безопасность", text: "Все изменения баланса происходят мгновенно и защищены облаком AmanPay." }
                ]
            };
            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 p-8 pt-20 animate-enter flex flex-col smooth-scroll">
                    <button onClick={onBack} className="fixed top-14 left-6 z-50 p-4 rounded-3xl glass-ui active:scale-90 shadow-lg text-slate-800 dark:text-white"><SvgIcon name="back" /></button>
                    <h2 className="text-5xl font-black dark:text-white mb-8 tracking-tight">Инструкция</h2>
                    <div className="flex p-2 bg-slate-200/50 dark:bg-slate-900 rounded-[2rem] mb-10">
                        <button onClick={() => setRole('client')} className={`flex-1 py-4 rounded-[1.5rem] font-bold transition-all ${role === 'client' ? 'bg-white dark:bg-slate-800 text-emerald-600 shadow-md' : 'text-slate-500'}`}>Клиенту</button>
                        <button onClick={() => setRole('agent')} className={`flex-1 py-4 rounded-[1.5rem] font-bold transition-all ${role === 'agent' ? 'bg-white dark:bg-slate-800 text-emerald-600 shadow-md' : 'text-slate-500'}`}>Агенту</button>
                    </div>
                    <div className="space-y-6">
                        {steps[role].map((step, idx) => (
                            <div key={idx} className="glass-ui p-8 rounded-[2.5rem] border border-white/50 dark:border-white/5 animate-enter" style={{animationDelay: `${idx * 100}ms`}}>
                                <div className="flex items-center space-x-4 mb-3">
                                    <div className="w-10 h-10 bg-emerald-500 rounded-2xl flex items-center justify-center text-white font-black">{idx + 1}</div>
                                    <h4 className="text-xl font-extrabold dark:text-white tracking-tight">{step.title}</h4>
                                </div>
                                <p className="text-slate-500 dark:text-slate-400 leading-relaxed font-medium">{step.text}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout }) => {
            const [balance, setBalance] = useState(user.balance);
            const [history, setHistory] = useState([]);
            const prevTxsCount = useRef(0);
            const isFirstLoad = useRef(true);

            useEffect(() => {
                const { collections, utils } = window.amanDB;
                const unsub = utils.onSnapshot(utils.doc(collections.users, user.fireId), (s) => s.exists() && setBalance(s.data().balance));
                const unsubH = utils.onSnapshot(collections.txs, (s) => {
                    const data = s.docs.map(d => ({...d.data(), id: d.id})).filter(t => t.userId === user.id).sort((a,b) => b.timestamp - a.timestamp);
                    if (!isFirstLoad.current && data.length > prevTxsCount.current) {
                        const newTx = data[0];
                        playSound(newTx.type === 'deposit' ? 'receive' : 'send');
                    }
                    setHistory(data);
                    prevTxsCount.current = data.length;
                    isFirstLoad.current = false;
                });
                return () => { unsub(); unsubH(); };
            }, [user.id, user.fireId]);

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 animate-enter flex flex-col smooth-scroll">
                    <div className="px-6 pt-20 pb-16">
                        <div className="premium-card p-8 rounded-[3.5rem] text-white flex flex-col justify-between h-64 relative">
                            <div className="flex justify-between items-start relative z-10">
                                <div><p className="opacity-80 text-[10px] font-black uppercase tracking-widest mb-1">Ваш баланс</p><h1 className="text-5xl font-black tracking-tight">{formatMoney(balance)}</h1></div>
                                <button onClick={onLogout} className="bg-white/20 backdrop-blur-md p-4 rounded-3xl active:scale-90 border border-white/20"><SvgIcon name="logout" /></button>
                            </div>
                            <div className="flex justify-between items-end relative z-10">
                                <div><p className="text-xs font-bold opacity-70 mb-1 uppercase">Держатель</p><p className="text-xl font-black">{user.name}</p></div>
                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-md border border-white/10"><SvgIcon name="wallet" /></div>
                            </div>
                        </div>
                    </div>
                    <div className="flex-1 px-6 space-y-10">
                        <div className="glass-ui p-10 rounded-[3rem] text-center shadow-xl flex flex-col items-center">
                            <p className="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase mb-6 tracking-widest">Персональный ID</p>
                            <div className="bg-emerald-500/5 dark:bg-emerald-500/10 p-8 rounded-[2.5rem] border-2 border-emerald-500/20 mb-6 group transition-all"><span className="text-6xl font-black text-emerald-600 dark:text-emerald-400 tracking-[0.15em]">{user.id}</span></div>
                            <p className="text-slate-400 dark:text-slate-500 text-sm font-semibold px-4">Для совершения операций назовите <br/>эти цифры агенту</p>
                        </div>
                        <div className="pb-10 px-2 space-y-4">
                           <h3 className="text-3xl font-black dark:text-white tracking-tight">Активность</h3>
                           {history.map((tx, idx) => (
                               <div key={tx.id || idx} className="glass-ui p-6 rounded-[2.5rem] flex justify-between items-center shadow-md animate-enter">
                                   <div className="flex items-center">
                                       <div className={`w-14 h-14 rounded-2xl flex items-center justify-center mr-5 ${tx.type==='deposit'?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-600'}`}><SvgIcon name={tx.type==='deposit' ? 'wallet' : 'logout'} className={tx.type==='withdraw' ? 'rotate-90' : ''} /></div>
                                       <div><p className="font-black dark:text-white text-xl leading-tight">{tx.type==='deposit'?'Приход':'Выдача'}</p><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">{tx.agentName}</p></div>
                                   </div>
                                   <div className="text-right"><p className={`font-black text-2xl tracking-tighter ${tx.type==='deposit'?'text-emerald-600':'dark:text-white'}`}>{tx.type==='deposit'?'+':'-'}{formatMoney(tx.amount)}</p></div>
                               </div>
                           ))}
                        </div>
                    </div>
                </div>
            );
        };

        const AgentPanel = ({ agent, onLogout }) => {
            const [searchId, setSearchId] = useState('');
            const [foundUser, setFoundUser] = useState(null);
            const [amount, setAmount] = useState('');
            const [msg, setMsg] = useState(null);
            const [isSearching, setIsSearching] = useState(false);

            const handleSearch = async () => {
                if(searchId.length < 4) return;
                setIsSearching(true); setMsg(null);
                const { collections, utils } = window.amanDB;
                const snap = await utils.getDocs(collections.users);
                const found = snap.docs.find(d => d.data().id === searchId && d.data().role === 'client');
                if(found) setFoundUser({...found.data(), fireId: found.id});
                else setMsg({type:'error', text:'Клиент не найден'});
                setIsSearching(false);
            };

            const handleOp = async (type) => {
                const val = parseInt(amount); if(!val) return;
                const { utils, collections } = window.amanDB;
                if(type === 'withdraw' && foundUser.balance < val) return setMsg({type:'error', text:'Лимит счета превышен'});
                try {
                    const newB = type === 'deposit' ? foundUser.balance + val : foundUser.balance - val;
                    await utils.updateDoc(utils.doc(collections.users, foundUser.fireId), { balance: newB });
                    await utils.addDoc(collections.txs, { type, amount: val, userId: foundUser.id, agentName: agent.name, timestamp: Date.now() });
                    playSound(type === 'deposit' ? 'receive' : 'send');
                    setFoundUser({...foundUser, balance: newB}); 
                    setMsg({type:'success', text:'Операция подтверждена'}); 
                    setAmount('');
                } catch(e) { setMsg({type:'error', text:'Ошибка транзакции'}); }
            };

            return (
                <div className="min-h-screen bg-slate-900 text-white animate-enter flex flex-col">
                    <div className="p-10 pt-20 flex justify-between items-center bg-slate-950/50 rounded-b-[4rem] shadow-xl">
                        <div><p className="text-emerald-400 text-[10px] font-black uppercase mb-1 tracking-widest">Точка обслуживания</p><h2 className="text-4xl font-black">{agent.name}</h2></div>
                        <button onClick={onLogout} className="bg-slate-800 p-4 rounded-3xl active:scale-90 border border-slate-700 shadow-lg"><SvgIcon name="logout"/></button>
                    </div>
                    <div className="px-8 flex-1 flex flex-col items-center pt-10">
                        <div className="bg-slate-800/50 p-10 rounded-[3.5rem] w-full max-w-[340px] mb-12 border border-slate-700 shadow-2xl text-center backdrop-blur-md">
                            <p className="text-[10px] font-black text-slate-500 uppercase mb-8 tracking-widest">Поиск по ID клиента</p>
                            <div className="flex items-center justify-center space-x-4">
                                <input type="number" inputMode="numeric" placeholder="0000" className="w-40 bg-slate-950 border-2 border-slate-700 rounded-3xl py-6 text-center text-5xl font-black outline-none focus:border-emerald-500 transition-all shadow-inner" value={searchId} onChange={e => {
                                    const v = e.target.value.slice(0,4);
                                    setSearchId(v);
                                    if(v.length === 4) { setFoundUser(null); setTimeout(handleSearch, 100); }
                                }} />
                                <button onClick={handleSearch} className="bg-emerald-500 p-6 rounded-3xl shadow-xl active:scale-90 flex items-center justify-center">{isSearching ? <div className="w-8 h-8 border-4 border-white/20 border-t-white rounded-full animate-spin"></div> : <SvgIcon name="search" className="w-8 h-8"/>}</button>
                            </div>
                        </div>
                        {msg && <div className={`p-6 rounded-3xl mb-10 w-full max-w-[340px] text-center font-black animate-enter shadow-2xl ${msg.type==='success'?'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20':'bg-rose-500/10 text-rose-400 border border-rose-500/20'}`}>{msg.text}</div>}
                        {foundUser && (
                            <div className="bg-white text-slate-900 rounded-[4rem] p-10 w-full max-w-[380px] animate-enter shadow-2xl relative overflow-hidden">
                                <h3 className="text-4xl font-black mb-1 tracking-tight">{foundUser.name}</h3>
                                <p className="text-slate-400 font-extrabold text-[10px] uppercase mb-10 tracking-[0.2em]">Клиент ID: {foundUser.id}</p>
                                <div className="bg-slate-50 p-8 rounded-[2.5rem] mb-10 border border-slate-100"><p className="text-slate-400 font-bold text-xs uppercase mb-1">Доступно</p><p className="text-5xl font-black text-emerald-600 tracking-tighter">{formatMoney(foundUser.balance)}</p></div>
                                <div className="space-y-8">
                                    <input type="number" inputMode="numeric" placeholder="Сумма" className="w-full bg-slate-50 border-2 border-slate-100 rounded-[2.5rem] py-10 px-8 text-7xl font-black text-center outline-none focus:border-emerald-500 shadow-inner" value={amount} onChange={e => setAmount(e.target.value)} />
                                    <div className="grid grid-cols-2 gap-5">
                                        <button onClick={() => handleOp('deposit')} className="bg-emerald-500 text-white p-10 rounded-[2.5rem] font-black flex flex-col items-center active:scale-95"><SvgIcon name="wallet" className="mb-3 w-10 h-10"/>Пополнить</button>
                                        <button onClick={() => handleOp('withdraw')} className="bg-slate-900 text-white p-10 rounded-[2.5rem] font-black flex flex-col items-center active:scale-95"><SvgIcon name="logout" className="rotate-90 mb-3 w-10 h-10"/>Выдать</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('welcome');
            const [user, setUser] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [isAuth, setIsAuth] = useState(false);

            useEffect(() => {
                const init = async () => {
                    if(!window.amanDB) return setTimeout(init, 100);
                    const { auth, utils } = window.amanDB;
                    await utils.signInAnonymously(auth);
                    utils.onAuthStateChanged(auth, (u) => setIsAuth(!!u));
                };
                init();
            }, []);

            const handleAuthResult = (u) => {
                setUser(u);
                if (u.role === 'client') setView('dash');
                else if (u.role === 'agent') setView('agent');
                else setView('welcome');
            };

            if(!isAuth) return <div className="min-h-screen bg-slate-50 dark:bg-slate-950 flex items-center justify-center"><div className="w-20 h-20 border-8 border-emerald-500 border-t-transparent rounded-full animate-spin"></div></div>;

            return (
                <div className={darkMode ? 'dark' : ''}>
                    <div className="bg-slate-50 dark:bg-slate-950 min-h-screen">
                        <ThemeToggle darkMode={darkMode} setDarkMode={setDarkMode} />
                        {view === 'welcome' && <WelcomeScreen onNavigate={setView} />}
                        {view === 'instructions' && <InstructionsScreen onBack={() => setView('welcome')} />}
                        {view === 'register' && <div className="animate-enter"><button onClick={() => setView('welcome')} className="fixed top-14 left-6 z-50 p-4 rounded-3xl glass-ui active:scale-90"><SvgIcon name="back" className="dark:text-white"/></button><Register onComplete={handleAuthResult} /></div>}
                        {view === 'login' && <div className="animate-enter"><button onClick={() => setView('welcome')} className="fixed top-14 left-6 z-50 p-4 rounded-3xl glass-ui active:scale-90"><SvgIcon name="back" className="dark:text-white"/></button><Login onComplete={handleAuthResult} /></div>}
                        {view === 'dash' && user && <Dashboard user={user} onLogout={() => setView('welcome')} />}
                        {view === 'agent' && user && <AgentPanel agent={user} onLogout={() => setView('welcome')} />}
                    </div>
                </div>
            );
        };

        const Register = ({ onComplete }) => {
            const [f, setF] = useState({ name: '', email: '', password: '', role: 'client' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const h = async () => {
                if(!f.name || !f.email || !f.password) return;
                setLoading(true);
                setError('');
                const { setDoc, doc, getDocs, collections } = window.amanDB.utils;
                
                try {
                    // Проверка уникальности Email
                    const snap = await getDocs(window.amanDB.collections.users);
                    const exists = snap.docs.some(d => d.data().email === f.email);
                    if (exists) {
                        setError('Пользователь с такой почтой уже существует');
                        setLoading(false);
                        return;
                    }

                    const id = Math.floor(1000 + Math.random() * 9000).toString();
                    const ref = doc(window.amanDB.collections.users);
                    const u = { ...f, id, balance: 0, fireId: ref.id };
                    await setDoc(ref, u);
                    onComplete(u);
                } catch(e) { setError('Ошибка регистрации'); setLoading(false); }
            };
            return (
                <div className="min-h-screen p-8 pt-44">
                    <h2 className="text-6xl font-black dark:text-white mb-10 tracking-tight">Регистрация</h2>
                    <div className="space-y-4">
                        <input placeholder="Ваше Имя" className="w-full p-6 rounded-3xl bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, name: e.target.value})} />
                        <input placeholder="Email" type="email" className="w-full p-6 rounded-3xl bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, email: e.target.value})} />
                        <input placeholder="Пароль" type="password" className="w-full p-6 rounded-3xl bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500 dark:text-white outline-none" onChange={e => setF({...f, password: e.target.value})} />
                        {error && <p className="text-rose-500 font-bold px-2">{error}</p>}
                        <div className="grid grid-cols-2 gap-4 pt-4">
                            <button onClick={() => setF({...f, role:'client'})} className={`p-6 rounded-[2rem] font-black ${f.role==='client'?'bg-emerald-500 text-white shadow-xl':'bg-white dark:bg-slate-900 dark:text-white border-2 border-slate-100 dark:border-slate-800'}`}>Клиент</button>
                            <button onClick={() => setF({...f, role:'agent'})} className={`p-6 rounded-[2rem] font-black ${f.role==='agent'?'bg-emerald-500 text-white shadow-xl':'bg-white dark:bg-slate-900 dark:text-white border-2 border-slate-100 dark:border-slate-800'}`}>Агент</button>
                        </div>
                    </div>
                    <button onClick={h} disabled={loading} className="w-full mt-10 bg-emerald-500 text-white py-6 rounded-[2rem] font-black text-xl shadow-2xl active:scale-95">{loading ? 'Создание...' : 'Завершить'}</button>
                </div>
            );
        };

        const Login = ({ onComplete }) => {
            const [f, setF] = useState({ email: '', password: '' });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const h = async () => {
                if(!f.email || !f.password) return;
                setLoading(true);
                setError('');
                const snap = await window.amanDB.utils.getDocs(window.amanDB.collections.users);
                const found = snap.docs.find(d => d.data().email === f.email && d.data().password === f.password);
                if(found) {
                    onComplete({...found.data(), fireId: found.id});
                } else {
                    setError('Неверная почта или пароль');
                    setLoading(false);
                }
            };
            return (
                <div className="min-h-screen p-8 pt-44">
                    <h2 className="text-6xl font-black dark:text-white mb-10 tracking-tight">Вход</h2>
                    <div className="space-y-4">
                        <input placeholder="Email" type="email" className="w-full p-6 rounded-3xl bg-white dark:bg-slate-900 dark:text-white outline-none border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500 shadow-sm" onChange={e => setF({...f, email: e.target.value})} />
                        <input placeholder="Пароль" type="password" className="w-full p-6 rounded-3xl bg-white dark:bg-slate-900 dark:text-white outline-none border-2 border-slate-100 dark:border-slate-800 focus:border-emerald-500 shadow-sm" onChange={e => setF({...f, password: e.target.value})} />
                        {error && <p className="text-rose-500 font-bold px-2">{error}</p>}
                    </div>
                    <button onClick={h} disabled={loading} className="w-full mt-10 bg-emerald-500 text-white py-6 rounded-[2rem] font-black text-xl shadow-2xl active:scale-95">{loading ? 'Вход...' : 'Войти'}</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
